---
title: ''
output: html_document
---

```{r include = FALSE}
opts_knit$set(root.dir=normalizePath('../'))
knitr::opts_chunk$set(echo = FALSE, fig.align='center', fig.pos = 'H', message = FALSE, warning = FALSE)
options(knitr.kable.NA = '')
```

```{r}
load("data/preproc_data.RData")
source('helpers/helpers.R')
source('helpers/settings.R')
```

### Bias and precision by group and session
```{r, results = 'asis'}
groupedSubjSes <- data %>%
  group_by(session, subject, treatment) %>%
  nest() %>%
  mutate(JV10e = map(.x = data, .f = ~bays_2009_error(X = .x$R_rad, Tg = .x$S_rad)))%>%
  mutate(precision = map_dbl(JV10e, 1), bias = map_dbl(JV10e, 2), 
         group = substr(subject, 1,1), 
         time = unlist(map(data, function(x) unique(x['time'])))) %>%
  select(-c("JV10e")) 

groupedData <- groupedData %>%
  mutate(JV10e = map(.x = data, .f = ~bays_2009_error(X = .x$R_rad, Tg = .x$S_rad)))%>%
  mutate(precision = map_dbl(JV10e, 1), bias = map_dbl(JV10e, 2)) %>%
  select(-c("JV10e"))

aux <- unlist(lapply(levels(data$session), function(x) setNames(2,x)))
aux0 <- apply(expand.grid(c("precision", "bias"), levels(data$session)), 
              1, paste, collapse=".")

groupedData %>%
  select(group, session, precision, bias) %>%
  as.data.frame() %>%
  reshape(idvar = 'group', timevar = 'session', direction = "wide",
          v.names = c('precision', 'bias')) %>%
  select(c("group", all_of(aux0))) %>%
  kable(col.names = c(Hmisc::label(data$group), 
                      rep(c("Precision", "Bias"), length(levels(data$session)))), 
        row.names = FALSE, booktabs = TRUE, escape = FALSE,
        caption = "Bias and precision by group and session.",
        digits = digits) %>%
  add_header_above(c(" " = 1, aux)) %>%
  kable_styling(latex_options = "HOLD_position", 
                bootstrap_options = "striped", full_width = F)
```


```{r fig.cap = 'Bias and precision by group and session.'}
b <- groupedSubjSes %>%
  ggplot(aes(x = session, y = abs(bias), color = group, group = group)) +
  geom_point(aes(group = subject), 
             position = position_jitterdodge(jitter.width = 0.01, dodge.width = 0.05), 
             alpha = 0.2) +
  stat_summary(fun.data = "mean_cl_boot", show.legend = FALSE,
               position = position_dodge(width = 0.05)) +
  stat_summary(fun = mean, geom = "line", size = 1, show.legend = FALSE,
               position=position_dodge(width = 0.05)) +
    scale_color_manual(values = colors) +
  labs(x = Hmisc::label(data$time), y = "Absolute bias", 
       color = Hmisc::label(data$group), group = Hmisc::label(data$group))


p <- groupedSubjSes %>%
  ggplot(aes(x = session, y = precision, color = group, group = group)) +
  geom_point(aes(group = subject),
             position= position_jitterdodge(jitter.width = 0.01, dodge.width = 0.05), alpha = 0.2) +
  stat_summary(fun.data = "mean_cl_boot",
               position=position_dodge(width=0.05)) +
  stat_summary(fun = mean, geom = "line",  size = 1, show.legend = FALSE,
               position=position_dodge(width=0.05)) +
    scale_color_manual(values=colors) +
  theme(legend.position=c(.9, .8)) +
  labs(x = Hmisc::label(data$time), y = "Precision", color = Hmisc::label(data$group), 
       group = Hmisc::label(data$group)) 

subplot(ggplotly(b), ggplotly(p)) %>%
  layout(annotations = list(
  list(x = 0.1 , y = 1.05, text = "Bias", showarrow = F, xref='paper', yref='paper'),
  list(x = 0.9 , y = 1.05, text = "Precision", showarrow = F, xref='paper', yref='paper')))
```

### Bias
```{r, fig.align='center', fig.height = 3, fig.cap = 'Bias by subject and group through time'}
g <- groupedSubjSes %>%
  ggplot(aes(x = session, y = abs(bias), color = group, group = subject)) +
  geom_line(alpha = 0.3, show.legend = FALSE) +
  stat_summary(fun.data = "mean_cl_boot", show.legend = FALSE,
               position = position_dodge(width = 0.05), aes(group = group)) +
  stat_summary(fun = mean, geom = "line", size = 1, show.legend = FALSE,
               position = position_dodge(width = 0.05), aes(group = group)) +
  scale_color_manual(values = colors) +
  theme_minimal(base_size = 15) +
  labs(x = Hmisc::label(data$time), y = "Absolute bias", color = Hmisc::label(data$group)) +
  facet_wrap(~ group)
ggplotly(g, tooltip = 'subject')
```

#### Modelling bias

##### Time as a continuous variable
```{r eval = FALSE}
mod0 <- lme(abs(bias) ~ group * time, random = ~(1+time)|subject, data = groupedSubjSes)
mod1 <- lme(abs(bias) ~ group * time, random = ~(1)|subject, data = groupedSubjSes)
mod2 <- lm(abs(bias) ~ group * session, 
           data = groupedSubjSes[groupedSubjSes$session %in% c('S1', 'S4'),])
mod3 <- lme(abs(bias) ~ group * session, random = ~1|subject, 
            data = groupedSubjSes[groupedSubjSes$session %in% c('S1', 'S4'),])
mod4 <- lme(abs(bias) ~ group * session, random = ~(1+session)|subject,
            data = groupedSubjSes[groupedSubjSes$session %in% c('S1', 'S4'),])

mod0$sigma # best with continous
mod1$sigma
summary(mod2)$sigma
mod3$sigma
mod4$sigma # best with categorical (best model)
```


```{r }
tryCatch(
  summary(lme(abs(bias) ~ group * time, random = ~(1+time)|subject, data = groupedSubjSes))$tTable %>%
  kable(digits = digits, booktabs = TRUE, escape = FALSE,
        caption = 'Linear mixed-effects model where the response is bias and regressors are group, time, its interaction and subject as a random factor.') %>%
    kable_styling(latex_options = "HOLD_position", 
                bootstrap_options = "striped", full_width = F),
  error = function(i) {
      summary(lm(abs(bias) ~ group * time, data = groupedSubjSes))$coefficients %>%
  kable(digits = digits, booktabs = TRUE, escape = FALSE,
        caption = 'Linear model where the response is bias and regressors are group, time, its interaction and subject as a random factor.') %>%
    kable_styling(latex_options = "HOLD_position", 
                bootstrap_options = "striped", full_width = F)
  })

tryCatch(
  anova(lme(abs(bias) ~ group * time, random = ~(1+group)|subject, data = groupedSubjSes)) %>%
    kable(digits = digits, booktabs = TRUE, escape = FALSE,
          caption = 'Anova of a linear mixed-effects model where the response is bias and regressors are group, time, its interaction and subject as a random factor.') %>%
      kable_styling(latex_options = "HOLD_position", 
                  bootstrap_options = "striped", full_width = F),
  error = function(i) {
      anova(lm(abs(bias) ~ group * time, data = groupedSubjSes)) %>%
  kable(digits = digits, booktabs = TRUE, escape = FALSE,
        caption = 'Anova of the linear model where the response is bias and regressors are group, time, its interaction and subject as a random factor..') %>%
    kable_styling(latex_options = "HOLD_position", 
                bootstrap_options = "striped", full_width = F)
  })
```

##### Time as categorical (session)

```{r }
tryCatch(
  summary(lme(abs(bias) ~ group * session, random = ~(1+session)|subject,
              data = groupedSubjSes[groupedSubjSes$session %in% c('S1', 'S4'),]))$tTable %>%
  kable(digits = digits, booktabs = TRUE, escape = FALSE,
        caption = 'Linear mixed-effects model where the response is bias and regressors are group, session, its interaction and subject as a random factor..') %>%
    kable_styling(latex_options = "HOLD_position", 
                bootstrap_options = "striped", full_width = F),
  error = function(i) {
      summary(lm(abs(bias) ~ group * session, 
          data = groupedSubjSes[groupedSubjSes$session %in% c('S1', 'S4'),]))$coefficients %>%
  kable(digits = digits, booktabs = TRUE, escape = FALSE,
        caption = 'Linear model where the response is bias and regressors are group, session, its interaction and subject as a random factor.') %>%
    kable_styling(latex_options = "HOLD_position", 
                bootstrap_options = "striped", full_width = F)
  })

tryCatch(
  anova(lme(abs(bias) ~ group * session, random = ~(1+session)|subject,
            data = groupedSubjSes[groupedSubjSes$session %in% c('S1', 'S4'),])) %>%
    kable(digits = digits, booktabs = TRUE, escape = FALSE,
          caption = 'Anova of a linear mixed-effects model where the response is bias and regressors are group, session, its interaction and subject as a random factor..') %>%
      kable_styling(latex_options = "HOLD_position", 
                  bootstrap_options = "striped", full_width = F),
  error = function(i) {
      anova(lm(abs(bias) ~ group * session, 
               data = groupedSubjSes[groupedSubjSes$session %in% c('S1', 'S4'),])) %>%
  kable(digits = digits, booktabs = TRUE, escape = FALSE,
        caption = 'Anova of the linear model where the response is bias and regressors are group, time, its interaction and subject as a random factor..') %>%
    kable_styling(latex_options = "HOLD_position", 
                bootstrap_options = "striped", full_width = F)
  })
```

###### Just for the encephalitis group (so we can take into account the 4 sessions)
```{r }
summary(lme(abs(bias) ~ session, random = ~(1+session)|subject,
              data = groupedSubjSes[groupedSubjSes$group == 'E',]))$tTable %>%
  kable(digits = digits, booktabs = TRUE, escape = FALSE,
        caption = 'Linear mixed-effects model with data for encephalitis group only. The response is bias and regressor are the sessions and a random factor for subject.') %>%
    kable_styling(latex_options = "HOLD_position", 
                bootstrap_options = "striped", full_width = F)

anova(lme(abs(bias) ~ session, random = ~(1+session)|subject,
            data = groupedSubjSes[groupedSubjSes$group == 'E',])) %>%
    kable(digits = digits, booktabs = TRUE, escape = FALSE,
          caption = 'Anova of a linear mixed-effects model with data for encephalitis group only. The response is bias and regressors are the sessions and a random factor for subject.') %>%
      kable_styling(latex_options = "HOLD_position", 
                  bootstrap_options = "striped", full_width = F)
```

### Precision

```{r, fig.align='center', fig.height = 3, fig.cap = 'Precision by subject and group through time'}
g <- groupedSubjSes %>%
  ggplot(aes(x = session, y = precision, color = group, group = subject)) +
  geom_line(alpha = 0.3, show.legend = FALSE) +
  stat_summary(fun.data = "mean_cl_boot", show.legend = FALSE,
               position = position_dodge(width = 0.05), aes(group = group)) +
  stat_summary(fun = mean, geom = "line", size = 1, show.legend = FALSE,
               position = position_dodge(width = 0.05), aes(group = group)) +
  scale_color_manual(values = colors) +
  theme_minimal(base_size = 15) +
  labs(x = Hmisc::label(data$time), y = "Precision", color =Hmisc:: label(data$group)) +
  facet_wrap(~ group)
ggplotly(g, tooltip = 'subject')
```

#### Modelling precision

```{r eval = FALSE}
rm(mod0, mod1, mod2, mod3, mod4)
mod0 <- lme(precision ~ group * time, random = ~(1+time)|subject, 
            data = groupedSubjSes)
mod1 <- lme(precision ~ group * time, random = ~(1)|subject, 
            data = groupedSubjSes)
mod2 <- lm(precision ~ group * session, 
           data = groupedSubjSes[groupedSubjSes$session %in% c('S1', 'S4'),])
mod3 <- lme(precision ~ group * session, random = ~1|subject, 
            data = groupedSubjSes[groupedSubjSes$session %in% c('S1', 'S4'),])
mod4 <- lme(precision ~ group * session, random = ~(1+session)|subject,
            data = groupedSubjSes[groupedSubjSes$session %in% c('S1', 'S4'),])
mod5 <- glmer(precision ~ group * time + (1|subject), 
      family = Gamma(link="log"), data = groupedSubjSes)
mod6 <- glmer(precision ~ group * session + (1|subject), 
      family = Gamma(link="log"), 
      data = groupedSubjSes[groupedSubjSes$session %in% c('S1', 'S4'),])
mod7 <- glm(precision ~ group * time + group * treatment,
      family = Gamma(link="log"), data = groupedSubjSes)
mod8 <- glm(precision ~ group*time + group*treatment ,
      family = Gamma(link="log"), data = groupedSubjSes)
# not working:
# mod8 <- glmer(precision ~ group*time + group*treatment + (1|subject),
#      family = Gamma(link="log"), data = groupedSubjSes)
mod9 <- glm(precision ~ group*session + group*treatment,
      family = Gamma(link="log"), 
      data = groupedSubjSes[groupedSubjSes$session %in% c('S1', 'S4'),])
# not working:
# mod9 <- glmer(precision ~ group*session + group*treatment + (1|subject),
#       family = Gamma(link="log"), 
#       data = groupedSubjSes[groupedSubjSes$session %in% c('S1', 'S4'),])

# continuous:
## within-group error standard deviation:
mod0$sigma 
mod1$sigma
summary(mod5)$sigma # best
sigma(mod7)
sigma(mod8)

## AIC:
AIC(mod0)
AIC(mod1)
AIC(mod5) # best
AIC(mod7)
AIC(mod8)

plot(residuals(mod5)~predict(mod5,type="link"), ylab="Deviance residuals")
hist(residuals(mod5)) # better
hist(residuals(mod1))

# categorical:
## within-group error standard deviation:
summary(mod2)$sigma
mod3$sigma
mod4$sigma # best with categorical
summary(mod6)$sigma
sigma(mod9)

## AIC:
AIC(mod2)
AIC(mod3)
AIC(mod4) 
AIC(mod6) # best

hist(residuals(mod4))
hist(residuals(mod6))
```


##### Time as a continuous variable

```{r}
summary(glmer(precision ~ group * time + (1|subject), 
      family = Gamma(link="log"), data = groupedSubjSes))$coefficients %>%
  kable(digits = digits, booktabs = TRUE, escape = FALSE,
        caption = 'Log-linked gamma generalized linear mixed model where the response is precision and regressors are group, time, its interaction and subject as a random factor.') %>%
    kable_styling(latex_options = "HOLD_position", 
                bootstrap_options = "striped", full_width = F)

Anova(glmer(precision ~ group * time + (1|subject), 
            family = Gamma(link="log"), data = groupedSubjSes)) %>%
  kable(digits = digits, booktabs = TRUE, escape = FALSE,
        caption = "Anova for the log-linked gamma generalized linear mixed-effects model where the response is precision and regressors are group, time, its interaction and subject as a random factor.") %>%
  kable_styling(latex_options = "HOLD_position", 
                bootstrap_options = "striped", full_width = F)
```

##### Time as a categorical variable (session)

```{r}
summary(glmer(precision ~ group * session + (1|subject), 
      family = Gamma(link="log"), 
      data = groupedSubjSes[groupedSubjSes$session %in% c('S1', 'S4'),]))$coefficients %>%
  kable(digits = digits, booktabs = TRUE, escape = FALSE,
        caption = 'Log-linked gamma generalized linear mixed model where the response is precision and regressors are group, session, its interaction and subject as a random factor.') %>%
    kable_styling(latex_options = "HOLD_position", 
                bootstrap_options = "striped", full_width = F)

Anova(glmer(precision ~ group * session + (1|subject), 
            family = Gamma(link="log"), 
            data = groupedSubjSes[groupedSubjSes$session %in% c('S1', 'S4'),])) %>%
  kable(digits = digits, booktabs = TRUE, escape = FALSE,
        caption = "Anova for the log-linked gamma generalized linear mixed-effects model where the response is precision and regressors are group, session, its interaction and subject as a random factor.") %>%
  kable_styling(latex_options = "HOLD_position", 
                bootstrap_options = "striped", full_width = F)
```

###### Just for the encephalitis group (so we can take into account the 4 sessions)
```{r}
summary(glmer(precision ~ session + (1|subject), 
      family = Gamma(link="log"), 
      data = groupedSubjSes[groupedSubjSes$group == 'E',]))$coefficients %>%
  kable(digits = digits, booktabs = TRUE, escape = FALSE,
        caption = 'Log-linked gamma generalized linear mixed model with data for encephalitis group only. The response is precision and regressors are session and subject as a random factor.') %>%
    kable_styling(latex_options = "HOLD_position", 
                bootstrap_options = "striped", full_width = F)

Anova(glmer(precision ~  session + (1|subject), 
            family = Gamma(link="log"), 
            data = groupedSubjSes[groupedSubjSes$group == 'E',])) %>%
  kable(digits = digits, booktabs = TRUE, escape = FALSE,
        caption = "Anova for the log-linked gamma generalized linear mixed-effects model with data for encephalitis group only. The response is precision and regressors are session and subject as a random factor.") %>%
  kable_styling(latex_options = "HOLD_position", 
                bootstrap_options = "striped", full_width = F)
```