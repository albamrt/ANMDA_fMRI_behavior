---
title: ''
output: html_document
---

```{r include = FALSE}
require(knitr)
opts_knit$set(root.dir=normalizePath('../'))
knitr::opts_chunk$set(echo = FALSE, fig.align='center', fig.pos = 'H', message = FALSE, warning = FALSE)
options(knitr.kable.NA = '')
```

```{r}
source('helpers/helpers.R')
source('helpers/settings.R')
beh <- read.csv("data/behaviour.csv", sep=";")
treatment <- read.csv("data/NMDAEventsProjecteAj-treatment.csv", sep=";") 
# REDcap treatment data
NMDAEvents <- read.csv("data/NMDAEventsProjecteAj-demo.csv", sep = ";") # REDcap info demo data
```

```{r}
# Add continuous time variable by categorizing session:
beh$time_cat <- recode(beh$session, S1 = 0, S2 = 3, S3 = 6, S4 = 12, S5 = 24) 

# Create variable time by using REDcap's data (more exact):
NMDAEvents <- NMDAEvents %>%
  select(record_id, redcap_event_name, n_visit, testing, birthdate, gender)
NMDAEvents$session <- paste0('S', substr(NMDAEvents$redcap_event_name, 8, 8))
NMDAEvents$testingDate <- as.POSIXct(NMDAEvents$testing, format = "%Y-%m-%d")

Visit0 <- NMDAEvents %>%
  group_by(record_id) %>%
  filter(!is.na(testingDate)) %>%
  filter(testingDate == min(testingDate)) %>%
  select(record_id, testingDate) %>%
  rename(V0 = testingDate)

NMDAEvents_all <- merge(NMDAEvents, Visit0, by = 'record_id', all.x = TRUE)
require(lubridate)
NMDAEvents_all$time <- interval(NMDAEvents_all$V0, NMDAEvents_all$testingDate) %/% months(1)
NMDAEvents_all <- NMDAEvents_all %>%
  rename(subject = record_id)

data <- merge(beh, NMDAEvents_all, by = c('subject', 'session'), all.x = TRUE, all.y = FALSE)
```

```{r}
# add treatment variable (from RedCap)
treatment <- treatment %>%
  mutate(session = paste0('S', substr(redcap_event_name, 8, 8))) %>%
  select(record_id, session, treatment)
colnames(treatment)[colnames(treatment) %in% 'record_id'] <- 'subject'
data <- merge(data, treatment, by = c('subject', 'session'), all.x = TRUE, all.y = FALSE)
data$treatment <- as.factor(data$treatment)
```


### Original data

```{r data}
# Label data:
label(data$trial) = "Trial number"
label(data$block) = "Block number"
label(data$run) = "Run"
label(data$type) = "Memory or non-memory trial"
label(data$S_Angle) = "Stimulus angle (deg)"
label(data$P_Angle) = "Probe angle (deg)"
label(data$R_Angle) = "Response angle (deg)"
label(data$RT) = "Response time (s)"
label(data$MT) = "MT"
label(data$ts_b) = "Beginning timestamp"
label(data$ts_p) = "Probe timestamp"
label(data$ts_d) = "delay timestamp"
label(data$ts_r) = "Response timestamp"
label(data$ts_m) = "Mask timestamp"
label(data$ts_e) = "End timestamp"
label(data$m_angle) = "m_angle"
label(data$m_clock) = "_clock"
label(data$S_rad) = "Stimulus angle (rad)"
label(data$P_rad) = "Probe angle (rad)"
label(data$R_rad) = "Response angle (rad)"
label(data$prevstim_rad) = "Previous stimulus angle (rad)"
label(data$prevresp_rad) = "Previous response angle (rad)"
label(data$prevprob_rad) = "Previous probe angle(rad)"
label(data$prevmem) = "Previous trial is memory?"
label(data$futurestim_rad) = "Next stimulus angle (rad)"
label(data$futureresp_rad) = "Next response angle (rad)"
label(data$subject) = "Subject"
label(data$session) = "Session"
label(data$group) = 'Group'
label(data$error) = "Error (rad)"
label(data$errorprevstim) = "Previous stim error relative to current stim"
label(data$errorprevresp) = "Previous resp error relative to current stim"
label(data$errorprevprobe) = "Previous probe error relative to current stim"
label(data$diffstim) = "Difference current-previous stim (rad)"
label(data$diffresp) = "Difference current stim-previous resp (rad)"
label(data$difffuture) = "Difference current-next stim (rad)"
label(data$difffutureresp) = "Difference current stim-next resp (rad)"
label(data$diffprevprob) = "Difference current stim-previous probe (rad)"
label(data$time) = "Time"

# Remove variables:
data$m_angle <- NULL
data$m_clock <- NULL

# exclude session 5:
data <- data[data$session != 'S5',]

# time from months to years:
#data$time <- data$time/12

# Convert variables to factors:
data$session <- as.factor(data$session)
data$session <- droplevels(data$session)
data$group <- as.factor(data$group)
data$subject <- as.factor(data$subject)

# Relevel factors:
data$group <- relevel(data$group, ref = 'C')

# Keep only memory trials:
data = data[data$type == 1, ]

# time from months to days
# data$time <- data$time*30
```


```{r summary}
groupedData <- data %>%
  group_by(group, session) %>%
  nest() %>%
  mutate(n = map(.x = data, .f = ~ n_distinct(.x$subject)),
         n_trials = map(.x = data, .f = ~ nrow(.x))) %>%
  unnest(c(n, n_trials))

groupedData %>%
  select(c(session, group, n)) %>%
  spread(session, n) %>%
  kable(digits = digits, booktabs = TRUE, escape = FALSE,
        caption = 'Summary of number of subjects by group and session.',
        align = c('l', rep('c', length(unique(data$session)) + 1)), 
        col.names = c(label(data$group), levels(data$session))) %>%
  kable_styling(position = "float_left",
              bootstrap_options = "striped", full_width = F) %>%
  column_spec(1:(length(unique(data$session)) + 1), "2cm") 


groupedData %>%
  select(c(session, group, n_trials)) %>%
  spread(session, n_trials) %>%
  kable(digits = digits, booktabs = TRUE, escape = FALSE,
        caption = 'Summary of number of trials by group and session.',
        align = c('l', rep('c', length(unique(data$session)) + 1)),
                col.names = c(label(data$group), levels(data$session))) %>%
  kable_styling(position = "center",
                bootstrap_options = "striped", full_width = F) %>%
  column_spec(1:(length(unique(data$session)) + 1), "2cm") 
```

#### Descriptive of the raw data

```{r RawPlots, fig.cap = 'Summary of the main variables', fig.show='hold', out.width = '33%', fig.ncol = 3, fig.align='center'}
summaryHist(data, "S_rad")
summaryHist(data, "P_rad")
summaryHist(data, "R_rad")
summaryHist(data, "error")
summaryHist(data, "RT")
```


### Preprocessing

- We remove the trials where the response time is greater than 2.8 seconds, as the maximum response time is of 3 seconds.
- We compute the outliers (error>0.7 radians) and remove the subjects with equal or more than 50% of trials being outliers.

```{r}
# Removing RT>2.8 (as max RT is 3, in these trials they probably needed more time):
data = data[data$RT<2.8,]
```

```{r}
all_outliers <- data %>% 
  group_by(subject, session) %>%
  summarise(outliers = sum(abs(error)>0.7), trials = n(), propout = sum(abs(error)>0.7)/n())
all_outliers$group <- as.factor(substr(all_outliers$subject, 1, 1))

# Subjects to remove, having more than 50% outlier trials (abs error>0.7):
outliers <- data %>% 
  group_by(subject, session) %>%
  summarise(outliers = sum(abs(error)>0.7), trials = n(), propout = sum(abs(error)>0.7)/n()) %>%
  filter(propout>=0.5) %>%
  ungroup()

# Removing subjects by visual inspection:
# outliers %>% add_row(
#   all_outliers %>%
#     # added subjects:
#   filter(subject == 'C26', session == 'S1') %>%
#   select(-group)
# )
```


The excluded subjects are:

```{r}
kable(outliers, digits = digits, booktabs = TRUE, escape = FALSE,
      caption = 'Outlier subjects removed from original data.',
      col.names = c(label(data$subject), label(data$session), 
                    "Number of outlier trials", "Total number of trials", 
                    "Proportion of outliers")) %>%
  kable_styling(latex_options = "HOLD_position", 
                bootstrap_options = "striped", full_width = F)
```

```{r}
# proportion of trials with RT<0.25:
low_RT <- data %>% 
  group_by(subject, session) %>%
  summarise(low_RT = sum(RT<0.25), trials = n(), prop_low_RT = sum(RT<0.25)/n())
low_RT$group <- as.factor(substr(low_RT$subject, 1, 1))
```


Here we can see all the subject's error distribution by session. The sessions being removed are marked with red borders.
```{r fig.cap = 'Error distribution by subject and session', fig.height = 40, fig.width = 8}
ggplot(data, aes(x = error, fill = group)) +
  geom_histogram(aes(y =..density..), bins = 30,
                 position = 'identity', alpha = 0.4) +
  scale_fill_manual(values = as.vector(colors)) +
  scale_color_manual(values = as.vector(colors)) +
  labs(x = Hmisc::label(data$error), fill = Hmisc::label(data$group))+
  facet_wrap(~ subject:session, ncol = 4) + 
  geom_rect(data = dplyr::inner_join(data, outliers), fill = NA, colour = "red",
            xmin = -Inf, xmax = Inf, ymin = -Inf, ymax = Inf) +
  geom_text(data = low_RT, aes(x = 0, y = 3.2,  
                               label = paste0("RT<0.25=", round(prop_low_RT, 2))),
            size = 4) +
  geom_text(data = all_outliers, aes(x = 0, y = 2.5, 
                               label = paste0("outliers=", round(propout, 2))),
            size = 4)
```

```{r}
# Removing outlier subjects:
data = data %>% 
  filter(!(paste(subject, session, sep = '') %in% paste(outliers$subject, outliers$session, sep = '')))

# removing outlier trials 
# data = data[abs(data$error) < 0.7,]
```


### Final dataset

This is the final number of subjects and trials by session after the preprocessing.

```{r summary2}
groupedData <- data %>%
  group_by(group, session) %>%
  nest() %>%
  mutate(n = map(.x = data, .f = ~ n_distinct(.x$subject)),
         n_trials = map(.x = data, .f = ~ nrow(.x))) %>%
  unnest(c(n, n_trials))

groupedData %>%
  select(c(session, group, n)) %>%
  spread(session, n) %>%
  kable(digits = digits, booktabs = TRUE, escape = FALSE,
        caption = 'Summary of number of subjects by group and session.',
        align = c('l', rep('c', length(unique(data$session)) + 1)), 
        col.names = c(label(data$group), levels(data$session))) %>%
  kable_styling(position = "float_left",
              bootstrap_options = "striped", full_width = F) %>%
  column_spec(1:(length(unique(data$session)) + 1), "2cm") 


groupedData %>%
  select(c(session, group, n_trials)) %>%
  spread(session, n_trials) %>%
  kable(digits = digits, booktabs = TRUE, escape = FALSE,
        caption = 'Summary of number of trials by group and session.',
        align = c('l', rep('c', length(unique(data$session)) + 1)),
                col.names = c(label(data$group), levels(data$session))) %>%
  kable_styling(position = "center",
                bootstrap_options = "striped", full_width = F) %>%
  column_spec(1:(length(unique(data$session)) + 1), "2cm") 
```

```{r}
save(data, groupedData, file = "data/preproc_data.RData")
```

